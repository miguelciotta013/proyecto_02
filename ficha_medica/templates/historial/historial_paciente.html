{% extends "base.html" %}

{% block title %}Historial Médico{% endblock %}

{% block content %}

  <div class="container mt-3">
    <!-- ENCABEZADO CON BOTÓN VOLVER VISIBLE -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>Historial Médico - {{ paciente.nombre }} {{ paciente.apellido }}</h2>
        <a href="{% url 'listar_pacientes' %}" class="btn btn-outline-secondary">
            Volver a Lista
        </a>
    </div>

    <!-- Mostrar mensajes -->
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        {% endfor %}
    {% endif %}

    <!-- DATOS DEL PACIENTE -->
    <div class="card mb-3">
        <div class="card-header py-2">
            <h5 class="mb-0">Datos del Paciente</h5>
        </div>
        <div class="card-body py-2">
            <div class="row g-2">
                <div class="col-md-6">
                    <div class="p-2 bg-light rounded">
                        <p class="mb-1 small"><strong>DNI:</strong> {{ paciente.dni_paciente }}</p>
                        <p class="mb-1 small"><strong>Nacimiento:</strong> {{ paciente.fecha_nacimiento }}</p>
                        <p class="mb-0 small"><strong>Teléfono:</strong> {{ paciente.telefono|default:"No especificado" }}</p>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="p-2 bg-light rounded">
                        <p class="mb-1 small"><strong>Domicilio:</strong> {{ paciente.domicilio|default:"No especificado" }}</p>
                        <p class="mb-0 small"><strong>Localidad:</strong> {{ paciente.localidad|default:"No especificada" }}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- FICHA MÉDICA -->
    <div class="card mb-3">
        <div class="card-header py-2">
            <div class="row align-items-center">
                <div class="col-8">
                    <h6 class="mb-0">Ficha Médica</h6>
                </div>
                <div class="col-4 text-end">
                    {% if tiene_ficha %}
                        <a href="{% url 'nueva_consulta' paciente.pk %}" class="btn btn-success btn-sm">
                            Nueva Consulta
                        </a>
                    {% else %}
                        <a href="{% url 'crear_ficha' paciente.pk %}" class="btn btn-primary btn-sm">
                            Crear Ficha Médica
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="card-body py-2">
            {% if tiene_ficha %}
                <div class="row">
                    <div class="col-md-12">
                        <p class="mb-1 small"><strong>Creación:</strong> {{ ficha_medica.fecha_creacion }}</p>
                        <p class="mb-1 small"><strong>Observaciones:</strong> {{ ficha_medica.observaciones|default:"Sin observaciones" }}</p>
                        <p class="mb-0 small"><strong>Responsable:</strong> {{ ficha_medica.id_usuario.first_name }} {{ ficha_medica.id_usuario.last_name }}</p>
                    </div>
                </div>
            {% else %}
                <div class="text-center py-2">
                    <p class="mb-0 text-muted">No tiene ficha médica</p>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- CONSULTAS ANTERIORES -->
    {% if consultas %}
    <div class="card mb-3">
        <div class="card-header py-2">
            <h6 class="mb-0">Consultas Anteriores ({{ consultas|length }})</h6>
        </div>
        <div class="card-body py-2">
            {% for consulta in consultas %}
            <div class="border-start border-3 border-primary ps-3 mb-2 pb-2">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h6 class="mb-1 text-primary">{{ consulta.fecha_consulta }}</h6>
                        <p class="mb-1 small">{{ consulta.observaciones|default:"Sin observaciones específicas" }}</p>
                    </div>
                    <div class="col-md-4 text-end">
                        <span class="badge bg-success">${{ consulta.total_consulta|default:"0" }}</span>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% else %}
    <!-- Mensaje cuando no hay consultas -->
    <div class="card mb-3">
        <div class="card-body text-center py-3">
            <div class="text-muted">
                <p class="mb-0">No hay consultas registradas</p>
                {% if tiene_ficha %}
                <a href="{% url 'nueva_consulta' paciente.pk %}" class="btn btn-success btn-sm mt-2">
                    Crear Primera Consulta
                </a>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- INFORMACIÓN ADICIONAL -->
    {% if tiene_ficha %}
    <div class="text-center">
        <small class="text-muted">Última actualización: {{ ficha_medica.updated_at|default:"No disponible" }}</small>
    </div>
    {% endif %}
</div>

{% endblock %}