{% extends 'base.html' %}
{% block title %}Cobrar Servicio - Clínica Odontológica{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h1 class="h2 text-success fw-bold">
                    <i class="fas fa-cash-register me-2"></i>
                    Cobrar Servicio Odontológico
                </h1>
                <a href="{% url 'caja:lista_cajas' %}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>
                    Volver a Lista
                </a>
            </div>
            <hr class="border-success">
        </div>
    </div>

    <!-- Info Caja Abierta -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-success" role="alert">
                <h5 class="alert-heading">
                    <i class="fas fa-unlock me-2"></i>
                    Caja Abierta - {{ caja_abierta.fecha_apertura|date:"d/m/Y" }}
                </h5>
                <p class="mb-0">
                    <strong>Usuario:</strong> {{ caja_abierta.id_usuario.get_full_name }} | 
                    <strong>Apertura:</strong> {{ caja_abierta.hora_apertura|date:"H:i" }} | 
                    <strong>Monto Inicial:</strong> ${{ caja_abierta.monto_apertura }}
                </p>
            </div>
        </div>
    </div>

    <form method="post" id="cobrarForm">
        {% csrf_token %}
        
        <!-- Errores generales -->
        {% if form.non_field_errors %}
            <div class="alert alert-danger" role="alert">
                {% for error in form.non_field_errors %}
                    <i class="fas fa-exclamation-triangle me-2"></i>{{ error }}
                {% endfor %}
            </div>
        {% endif %}

        <div class="row">
            <!-- Datos del Servicio -->
            <div class="col-lg-6">
                <div class="card shadow">
                    <div class="card-header bg-primary text-white">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-user-injured me-2"></i>
                            Datos del Servicio
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- Paciente -->
                        <div class="mb-3">
                            <label for="{{ form.id_paciente.id_for_label }}" class="form-label">
                                <i class="fas fa-user me-2"></i>{{ form.id_paciente.label }}
                            </label>
                            {{ form.id_paciente }}
                            {% if form.id_paciente.errors %}
                                <div class="text-danger mt-1">
                                    {% for error in form.id_paciente.errors %}
                                        <small><i class="fas fa-exclamation-circle me-1"></i>{{ error }}</small>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <!-- Método de Pago -->
                        <div class="mb-3">
                            <label for="{{ form.metodo_pago.id_for_label }}" class="form-label">
                                <i class="fas fa-credit-card me-2"></i>{{ form.metodo_pago.label }}
                            </label>
                            {{ form.metodo_pago }}
                            {% if form.metodo_pago.errors %}
                                <div class="text-danger mt-1">
                                    {% for error in form.metodo_pago.errors %}
                                        <small><i class="fas fa-exclamation-circle me-1"></i>{{ error }}</small>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <!-- Total (calculado automáticamente) -->
                        <div class="mb-3">
                            <label for="{{ form.total.id_for_label }}" class="form-label">
                                <i class="fas fa-calculator me-2"></i>{{ form.total.label }}
                            </label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                {{ form.total }}
                            </div>
                            {% if form.total.errors %}
                                <div class="text-danger mt-1">
                                    {% for error in form.total.errors %}
                                        <small><i class="fas fa-exclamation-circle me-1"></i>{{ error }}</small>
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <div class="form-text">
                                <i class="fas fa-info-circle me-1"></i>
                                Se calcula automáticamente según los tratamientos
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Detalles de Tratamientos -->
            <div class="col-lg-6">
                <div class="card shadow">
                    <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-tooth me-2"></i>
                            Tratamientos Realizados
                        </h5>
                        <button type="button" class="btn btn-sm btn-light" id="agregar-tratamiento">
                            <i class="fas fa-plus me-1"></i>Agregar
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="tratamientos-container">
                            {{ formset.management_form }}
                            
                            {% for form in formset %}
                                <div class="tratamiento-form border rounded p-3 mb-3" data-form-index="{{ forloop.counter0 }}">
                                    {% if forloop.counter0 > 0 %}
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <h6 class="text-primary mb-0">Tratamiento #{{ forloop.counter }}</h6>
                                            <button type="button" class="btn btn-sm btn-outline-danger eliminar-tratamiento">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    {% else %}
                                        <h6 class="text-primary mb-3">Tratamiento #1</h6>
                                    {% endif %}

                                    <div class="row g-2">
                                        <!-- Número de diente -->
                                        <div class="col-md-4">
                                            <label class="form-label small">Nº Diente</label>
                                            {% for field in form %}
                                                {% if field.name == 'nro_diente' %}
                                                    {{ field }}
                                                {% endif %}
                                            {% endfor %}
                                        </div>

                                        <!-- Tratamiento -->
                                        <div class="col-md-8">
                                            <label class="form-label small">Tratamiento</label>
                                            {% for field in form %}
                                                {% if field.name == 'tratamiento' %}
                                                    {{ field }}
                                                {% endif %}
                                            {% endfor %}
                                        </div>

                                        <!-- Importe -->
                                        <div class="col-md-12">
                                            <label class="form-label small">Importe</label>
                                            <div class="input-group">
                                                <span class="input-group-text">$</span>
                                                {% for field in form %}
                                                    {% if field.name == 'importe' %}
                                                        {{ field }}
                                                    {% endif %}
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Campos ocultos del formset -->
                                    {% for field in form %}
                                        {% if field.is_hidden %}
                                            {{ field }}
                                        {% endif %}
                                    {% endfor %}

                                    <!-- Errores del form -->
                                    {% if form.non_field_errors %}
                                        <div class="text-danger mt-2">
                                            {% for error in form.non_field_errors %}
                                                <small>{{ error }}</small>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            {% endfor %}
                        </div>

                        <!-- Resumen de Total -->
                        <div class="bg-light p-3 rounded">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="fw-bold">Total Calculado:</span>
                                <span class="fw-bold text-success fs-5" id="total-calculado">$0.00</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Botones de Acción -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body text-center">
                        <div class="d-grid gap-2 d-md-flex justify-content-md-center">
                            <button type="submit" class="btn btn-success btn-lg me-md-2">
                                <i class="fas fa-cash-register me-2"></i>
                                Cobrar Servicio
                            </button>
                            <a href="{% url 'caja:lista_cajas' %}" class="btn btn-outline-secondary btn-lg">
                                <i class="fas fa-times me-2"></i>
                                Cancelar
                            </a>
                        </div>
                        
                        <div class="mt-3 text-muted">
                            <small>
                                <i class="fas fa-info-circle me-1"></i>
                                El servicio será registrado en la caja abierta actual
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Template para nuevos tratamientos (oculto) -->
<div id="tratamiento-template" class="d-none">
    <div class="tratamiento-form border rounded p-3 mb-3">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="text-primary mb-0">Nuevo Tratamiento</h6>
            <button type="button" class="btn btn-sm btn-outline-danger eliminar-tratamiento">
                <i class="fas fa-trash"></i>
            </button>
        </div>
        
        <div class="row g-2">
            <div class="col-md-4">
                <label class="form-label small">Nº Diente</label>
                <input type="number" class="form-control" min="1" max="32" placeholder="1-32">
            </div>
            <div class="col-md-8">
                <label class="form-label small">Tratamiento</label>
                <input type="text" class="form-control" placeholder="Descripción del tratamiento">
            </div>
            <div class="col-md-12">
                <label class="form-label small">Importe</label>
                <div class="input-group">
                    <span class="input-group-text">$</span>
                    <input type="number" class="form-control" min="0" step="0.01" placeholder="0.00">
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const totalInput = document.getElementById('id_total');
    const totalCalculadoSpan = document.getElementById('total-calculado');
    let formIndex = {{ formset.total_form_count }};

    // Función para calcular el total
    function calcularTotal() {
        let total = 0;
        const importeInputs = document.querySelectorAll('[name*="importe"]');
        
        importeInputs.forEach(input => {
            const valor = parseFloat(input.value) || 0;
            total += valor;
        });

        totalInput.value = total.toFixed(2);
        totalCalculadoSpan.textContent = ' + total.toFixed(2);
    }

    // Event listeners para calcular total automáticamente
    document.addEventListener('input', function(e) {
        if (e.target.name && e.target.name.includes('importe')) {
            calcularTotal();
        }
    });

    // Agregar nuevo tratamiento
    document.getElementById('agregar-tratamiento').addEventListener('click', function() {
        const container = document.getElementById('tratamientos-container');
        const template = document.getElementById('tratamiento-template').firstElementChild.cloneNode(true);
        
        // Actualizar índices de los campos
        template.innerHTML = template.innerHTML
            .replace(/(__prefix__)/g, formIndex)
            .replace(/(form-\d+-)/g, `form-${formIndex}-`);
        
        template.querySelector('h6').textContent = `Tratamiento #${formIndex + 1}`;
        container.appendChild(template);
        
        // Actualizar contador de formularios
        const totalFormsInput = document.querySelector('[name$="TOTAL_FORMS"]');
        totalFormsInput.value = parseInt(totalFormsInput.value) + 1;
        formIndex++;
    });

    // Eliminar tratamiento
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('eliminar-tratamiento') || 
            e.target.closest('.eliminar-tratamiento')) {
            
            const tratamientoForm = e.target.closest('.tratamiento-form');
            
            // Marcar para eliminación si ya existe en BD
            const deleteInput = tratamientoForm.querySelector('[name*="DELETE"]');
            if (deleteInput) {
                deleteInput.checked = true;
                tratamientoForm.style.display = 'none';
            } else {
                tratamientoForm.remove();
                // Actualizar contador
                const totalFormsInput = document.querySelector('[name$="TOTAL_FORMS"]');
                totalFormsInput.value = parseInt(totalFormsInput.value) - 1;
            }
            
            calcularTotal();
        }
    });

    // Validaciones del formulario
    document.getElementById('cobrarForm').addEventListener('submit', function(e) {
        const paciente = document.getElementById('id_id_paciente').value;
        const metodoPago = document.getElementById('id_metodo_pago').value;
        const total = parseFloat(totalInput.value) || 0;

        if (!paciente) {
            e.preventDefault();
            alert('Por favor, seleccione un paciente.');
            return false;
        }

        if (!metodoPago) {
            e.preventDefault();
            alert('Por favor, seleccione un método de pago.');
            return false;
        }

        if (total <= 0) {
            e.preventDefault();
            alert('Debe agregar al menos un tratamiento con importe mayor a 0.');
            return false;
        }

        // Validar que hay al menos un tratamiento
        const tratamientoInputs = document.querySelectorAll('[name*="tratamiento"]:not([name*="DELETE"])');
        let tieneTratamientos = false;
        
        tratamientoInputs.forEach(input => {
            if (input.value.trim() && !input.closest('.tratamiento-form').querySelector('[name*="DELETE"]:checked')) {
                tieneTratamientos = true;
            }
        });

        if (!tieneTratamientos) {
            e.preventDefault();
            alert('Debe agregar al menos un tratamiento.');
            return false;
        }

        // Confirmación final
        const pacienteTexto = document.getElementById('id_id_paciente').selectedOptions[0].text;
        if (!confirm(`¿Confirma el cobro de ${total.toFixed(2)} a ${pacienteTexto}?`)) {
            e.preventDefault();
            return false;
        }
    });

    // Formatear inputs de importe
    document.addEventListener('input', function(e) {
        if (e.target.name && e.target.name.includes('importe')) {
            let value = e.target.value;
            value = value.replace(/[^0-9.]/g, '');
            const parts = value.split('.');
            if (parts.length > 2) {
                value = parts[0] + '.' + parts[1];
            }
            e.target.value = value;
        }
    });

    // Filtro de búsqueda para pacientes
    const pacienteSelect = document.getElementById('id_id_paciente');
    const originalOptions = Array.from(pacienteSelect.options);
    
    // Agregar input de búsqueda
    const searchInput = document.createElement('input');
    searchInput.type = 'text';
    searchInput.className = 'form-control mb-2';
    searchInput.placeholder = 'Buscar paciente...';
    pacienteSelect.parentNode.insertBefore(searchInput, pacienteSelect);
    
    searchInput.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        pacienteSelect.innerHTML = '';
        
        originalOptions.forEach(option => {
            if (option.text.toLowerCase().includes(searchTerm)) {
                pacienteSelect.appendChild(option.cloneNode(true));
            }
        });
    });

    // Inicializar cálculo
    calcularTotal();
});
</script>
{% endblock %}