{% extends 'base.html' %}

{% block title %}Cobrar Servicio{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-10">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Cobrar Servicio</h5>
            </div>
            <div class="card-body">

                <!-- Contenedor de Toasts -->
                <div class="position-fixed top-0 end-0 p-3" style="z-index: 1100">
                    {% if messages %}
                        {% for message in messages %}
                            <div class="toast align-items-center text-bg-{{ message.tags }} border-0 mb-2" role="alert" aria-live="assertive" aria-atomic="true">
                                <div class="d-flex">
                                    <div class="toast-body">
                                        {{ message }}
                                    </div>
                                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                                </div>
                            </div>
                        {% endfor %}
                    {% endif %}
                </div>

                <!-- Información de la caja actual -->
                <div class="alert alert-info mb-4">
                    <h6><strong>Caja Actual:</strong></h6>
                    <p class="mb-1"><strong>Usuario:</strong> {{ caja_abierta.id_usuario.username }}</p>
                    <p class="mb-0"><strong>Fecha:</strong> {{ caja_abierta.fecha_apertura|date:'d/m/Y' }}</p>
                </div>

                <form method="post" id="cobrarForm">
                    {% csrf_token %}

                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="mb-3">Información del Servicio</h6>
                            
                            <div class="mb-3">
                                <label for="{{ servicio_form.id_paciente.id_for_label }}" class="form-label fw-bold">
                                    {{ servicio_form.id_paciente.label }}
                                </label>
                                {{ servicio_form.id_paciente }}
                                {% if servicio_form.id_paciente.errors %}
                                    <div class="text-danger mt-1">
                                        {% for error in servicio_form.id_paciente.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>

                            <div class="mb-3">
                                <label for="{{ servicio_form.total.id_for_label }}" class="form-label fw-bold">
                                    {{ servicio_form.total.label }}
                                </label>
                                {{ servicio_form.total }}
                                {% if servicio_form.total.errors %}
                                    <div class="text-danger mt-1">
                                        {% for error in servicio_form.total.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>

                            <!-- Estado de Pago como select -->
                            <div class="mb-3">
                                <label for="id_estado_pago" class="form-label fw-bold">Estado de Pago</label>
                                <select name="estado_pago" id="id_estado_pago" class="form-select">
                                    <option value="pendiente" {% if servicio_form.estado_pago.value == 'pendiente' %}selected{% endif %}>Pendiente</option>
                                    <option value="pagado" {% if servicio_form.estado_pago.value == 'pagado' %}selected{% endif %}>Pagado</option>
                                    <option value="cancelado" {% if servicio_form.estado_pago.value == 'cancelado' %}selected{% endif %}>Cancelado</option>
                                    <option value="parcial" {% if servicio_form.estado_pago.value == 'parcial' %}selected{% endif %}>Parcial</option>
                                </select>
                                {% if servicio_form.estado_pago.errors %}
                                    <div class="text-danger mt-1">
                                        {% for error in servicio_form.estado_pago.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>

                            <!-- Método de Pago como select -->
                            <div class="mb-3">
                                <label for="id_metodo_pago" class="form-label fw-bold">Método de Pago</label>
                                <select name="metodo_pago" id="id_metodo_pago" class="form-select">
                                    <option value="efectivo" {% if servicio_form.metodo_pago.value == 'efectivo' %}selected{% endif %}>Efectivo</option>
                                    <option value="transferencia" {% if servicio_form.metodo_pago.value == 'transferencia' %}selected{% endif %}>Transferencia</option>
                                </select>
                                {% if servicio_form.metodo_pago.errors %}
                                    <div class="text-danger mt-1">
                                        {% for error in servicio_form.metodo_pago.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>

                        </div>

                        <div class="col-md-6">
                            <h6 class="mb-3">Detalle del Tratamiento</h6>

                            <div class="mb-3">
                                <label for="{{ detalle_form.tratamiento.id_for_label }}" class="form-label fw-bold">
                                    {{ detalle_form.tratamiento.label }}
                                </label>
                                {{ detalle_form.tratamiento }}
                                {% if detalle_form.tratamiento.errors %}
                                    <div class="text-danger mt-1">
                                        {% for error in detalle_form.tratamiento.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>

                            <div class="mb-3">
                                <label for="{{ detalle_form.nro_diente.id_for_label }}" class="form-label fw-bold">
                                    {{ detalle_form.nro_diente.label }}
                                </label>
                                {{ detalle_form.nro_diente }}
                                <small class="form-text text-muted">Opcional (1-48)</small>
                                {% if detalle_form.nro_diente.errors %}
                                    <div class="text-danger mt-1">
                                        {% for error in detalle_form.nro_diente.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>

                            <div class="mb-3">
                                <label for="{{ detalle_form.importe.id_for_label }}" class="form-label fw-bold">
                                    {{ detalle_form.importe.label }}
                                </label>
                                {{ detalle_form.importe }}
                                {% if detalle_form.importe.errors %}
                                    <div class="text-danger mt-1">
                                        {% for error in detalle_form.importe.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <hr class="my-4">

                    <div class="d-flex justify-content-between">
                        <a href="{% url 'caja:lista_cajas' %}" class="btn btn-secondary">
                            Cancelar
                        </a>
                        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#confirmModal">
                            Registrar Servicio
                        </button>
                    </div>
                </form>

                <!-- Modal de confirmación -->
                <div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="confirmModalLabel">Confirmar Cobro</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                            </div>
                            <div class="modal-body">
                                ¿Estás seguro de registrar este servicio y cobrarlo?
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                <button type="button" class="btn btn-primary" id="confirmSubmit">Sí, cobrar</button>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    // Inicializar Toasts
    var toastElList = [].slice.call(document.querySelectorAll('.toast'))
    toastElList.map(function (toastEl) {
        var toast = new bootstrap.Toast(toastEl, { delay: 5000 })
        toast.show()
    })

    // Confirmación de cobro
    document.getElementById('confirmSubmit').addEventListener('click', function () {
        document.getElementById('cobrarForm').submit();
    })
})
</script>
{% endblock %}
