{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'caja/css/caja.css' %}">
{% endblock %}

{% block title %}Cerrar Caja{% endblock %}

{% block content %}
<h1 class="titulo-cerrar-caja">Cerrar Caja</h1>

<form id="form-cerrar-caja" class="form-cerrar-caja">
    <div class="form-container-cerrar">
        <label for="hora-cierre" class="label-cerrar">Hora Cierre:</label>
        <input type="time" id="hora-cierre" name="hora_cierre" class="input-cerrar">

        <label for="monto-final" class="label-cerrar">Monto Final:</label>
        <input type="number" id="monto-final" name="monto_final" class="input-cerrar" placeholder="Monto Final">

        <label for="responsable-cerrar" class="label-cerrar">Responsable:</label>
        <input type="text" id="responsable-cerrar" name="responsable" class="input-cerrar" placeholder="Responsable">

        <button type="button" id="btn-cerrar-caja" class="btn-cerrar">Cerrar Caja</button>
        <button type="button" id="btn-volver" class="btn-volver">⬅️ Volver</button>
    </div>
</form>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', () => {

    // Función para enviar POST vía AJAX
    async function cerrarCaja() {
        const hora_cierre = document.getElementById('hora-cierre').value.trim();
        const monto_final = document.getElementById('monto-final').value.trim();
        const responsable = document.getElementById('responsable-cerrar').value.trim();

        if (!hora_cierre || !monto_final || !responsable) {
            alert("⚠️ Todos los campos son obligatorios");
            return;
        }

        try {
            const response = await fetch("{% url 'caja:cerrar_caja_ajax' %}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": "{{ csrf_token }}"
                },
                body: JSON.stringify({ hora_cierre, monto_final, responsable })
            });

            const data = await response.json();

            if (response.ok) {
                alert(data.mensaje || "Caja cerrada correctamente ✅");
                document.getElementById('form-cerrar-caja').reset();
                // Redirigir a la página de cajas abiertas
                window.location.href = "{% url 'caja:caja_home' %}";
            } else {
                alert(data.mensaje || "Error al cerrar la caja ❌");
            }

        } catch (error) {
            console.error(error);
            alert("Ocurrió un error al procesar la solicitud.");
        }
    }

    // Event listeners
    document.getElementById('btn-cerrar-caja').addEventListener('click', cerrarCaja);
    document.getElementById('btn-volver').addEventListener('click', () => {
        window.location.href = "{% url 'caja:caja_home' %}";
    });

});
</script>
{% endblock %}
